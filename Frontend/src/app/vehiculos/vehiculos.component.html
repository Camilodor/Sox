<div class="vehiculos-container" *ngIf="data$ | async as data; else cargando">
  <h2>üöö Gesti√≥n de Veh√≠culos</h2>

  <!-- üîî Alertas -->
  <div *ngIf="alertaVisible" class="alerta" [ngClass]="alertaTipo">
    {{ alertaMensaje }}
    <button class="cerrar" (click)="cerrarAlerta()">√ó</button>
  </div>

  <!-- Bot√≥n Nuevo + Exportaciones -->
  <div class="acciones-bar">
    <button class="btn-nuevo" (click)="abrirModal()">
      <i class="bi bi-truck"></i> Nuevo Veh√≠culo
    </button>
     <div class="descargas-container">
    <div class="dropdown" (click)="$event.stopPropagation()">
      <button class="btn-nuevo1" type="button" (click)="toggleDropdown($event)">
        ‚¨áÔ∏è Descargas
      </button>
      <ul class="dropdown-menu" *ngIf="dropdownOpen">
        <li><a class="dropdown-item" (click)="exportarExcel(data.vehiculos)">üìä Excel</a></li>
        <li><a class="dropdown-item" (click)="exportarCSV(data.vehiculos)">üìÑ CSV</a></li>
        <li><a class="dropdown-item" (click)="exportarWord(data.vehiculos)">üìù Word</a></li>
        <li><a class="dropdown-item" (click)="exportarPDF(data.vehiculos)">üìï PDF</a></li>
      </ul>
    </div>
  </div>
  </div>

  <!-- Tabla de veh√≠culos -->
  <div class="tabla-wrapper">
    <table class="tabla-vehiculos">
      <thead>
        <tr>
          <th (click)="ordenar('id')">ID</th>
          <th (click)="ordenar('numero_placas')">Placa</th>
          <th (click)="ordenar('nombre_marca_vehiculo')">Marca</th>
          <th (click)="ordenar('nombre_propietario_vehiculo')">Propietario</th>
          <th (click)="ordenar('usuario.numero_documento')">Conductor</th>
          <th class="acciones-col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let v of vehiculosFiltrados(data.vehiculos) | paginate: { itemsPerPage: pageSize, currentPage: page }">
          <td>{{ v.id }}</td>
          <td>{{ v.numero_placas }}</td>
          <td>{{ v.nombre_marca_vehiculo }}</td>
          <td>{{ v.nombre_propietario_vehiculo }}</td>
          <td>{{ v.usuario?.numero_documento }} - {{ v.usuario?.nombre_completo }}</td>
          <td class="acciones">
            <button class="btn-accion consultar" (click)="consultarVehiculo(v.id)" title="Consultar"></button>
            <button class="btn-accion editar" (click)="abrirModal(v)" title="Editar"></button>
            <button class="btn-accion eliminar" (click)="eliminarVehiculo(v.id)" title="Eliminar"></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- üìå Paginaci√≥n -->
  <pagination-controls (pageChange)="page = $event" class="paginacion"></pagination-controls>

  <!-- Modal de consulta -->
  <div class="modal" *ngIf="vehiculoConsultado">
    <div class="modal-content">
      <h3>üöõ Detalles del Veh√≠culo</h3>
      <ul>
        <li><strong>ID:</strong> {{ vehiculoConsultado.id }}</li>
        <li><strong>Placas:</strong> {{ vehiculoConsultado.numero_placas }}</li>
        <li><strong>Marca:</strong> {{ vehiculoConsultado.nombre_marca_vehiculo }}</li>
        <li><strong>Propietario:</strong> {{ vehiculoConsultado.nombre_propietario_vehiculo }}</li>
        <li><strong>Documento Propietario:</strong> {{ vehiculoConsultado.documento_propietario_vehiculo }}</li>
        <li><strong>Tel√©fono:</strong> {{ vehiculoConsultado.numero_celular_propietario }}</li>
        <li><strong>Direcci√≥n:</strong> {{ vehiculoConsultado.direccion_propietario }}</li>
        <li><strong>Ciudad:</strong> {{ vehiculoConsultado.ciudad_propietario }}</li>
        <li><strong>Modelo:</strong> {{ vehiculoConsultado.numero_modelo_anio }}</li>
        <li><strong>Color:</strong> {{ vehiculoConsultado.color_vehiculo }}</li>
        <li><strong>Conductor:</strong> {{ vehiculoConsultado.usuario?.nombre_completo }} ({{ vehiculoConsultado.usuario?.numero_documento }})</li>
      </ul>
      <div class="modal-buttons">
        <button class="btn-cancelar" (click)="cerrarConsulta()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de crear/editar -->
  <div class="modal" *ngIf="modalVisible">
    <div class="modal-content">
      <h3>{{ editando ? '‚úèÔ∏è Editar Veh√≠culo' : '‚ûï Nuevo Veh√≠culo' }}</h3>
      <div class="form-grid">
        <input placeholder="N√∫mero Placas" [(ngModel)]="vehiculoForm.numero_placas" required />
        <input placeholder="Marca" [(ngModel)]="vehiculoForm.nombre_marca_vehiculo" required />
        <input placeholder="Nombre Propietario" [(ngModel)]="vehiculoForm.nombre_propietario_vehiculo" required />
        <input placeholder="Documento Propietario" [(ngModel)]="vehiculoForm.documento_propietario_vehiculo" required />
        <input placeholder="Celular Propietario" [(ngModel)]="vehiculoForm.numero_celular_propietario" required />
        <input placeholder="Direcci√≥n Propietario" [(ngModel)]="vehiculoForm.direccion_propietario" required />
        <input placeholder="Ciudad Propietario" [(ngModel)]="vehiculoForm.ciudad_propietario" required />
        <input placeholder="Modelo (A√±o)" [(ngModel)]="vehiculoForm.numero_modelo_anio" required />
        <input placeholder="Color" [(ngModel)]="vehiculoForm.color_vehiculo" required />
        <input type="date" placeholder="Vencimiento SOAT" [(ngModel)]="vehiculoForm.fecha_vencimiento_soat" />
        <input type="date" placeholder="Vencimiento Tecno" [(ngModel)]="vehiculoForm.fecha_vencimiento_tecno" />
        <input placeholder="Nombre Satelital" [(ngModel)]="vehiculoForm.nombre_satelital" />
        <input placeholder="Usuario Satelital" [(ngModel)]="vehiculoForm.usuario_satelital" />
        <input placeholder="Contrase√±a Satelital" [(ngModel)]="vehiculoForm.contrasena_satelital" />
        <input type="number" placeholder="Capacidad Carga (Kg)" [(ngModel)]="vehiculoForm.capacidad_carga" />
        <input placeholder="N√∫mero Documento Conductor" [(ngModel)]="vehiculoForm.numero_documento" required />
      </div>
      <div class="modal-buttons">
        <button class="btn-guardar" (click)="guardarVehiculo()">{{ editando ? 'Actualizar' : 'Crear' }}</button>
        <button class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<ng-template #cargando>
  <div class="spinner-container">
    <div class="spinner"></div>
    <p>Cargando veh√≠culos...</p>
  </div>
</ng-template>
