<div class="usuarios-container" *ngIf="data$ | async as data; else cargando">
  <h2>ğŸ‘¥ GestiÃ³n de Usuarios</h2>

  <!-- ğŸ”” Caja de alertas -->
  <div *ngIf="alertaVisible" class="alerta" [ngClass]="alertaTipo">
    {{ alertaMensaje }}
    <button class="cerrar" (click)="cerrarAlerta()">Ã—</button>
  </div>

 <div class="descargas-container">
  <div class="dropdown" (click)="$event.stopPropagation()">
    <button class="btn-nuevo1" type="button" (click)="toggleDropdown($event)">
      â¬‡ï¸ Descargas
    </button>

    <ul class="dropdown-menu" *ngIf="dropdownOpen">
      <li><a class="dropdown-item" (click)="exportarExcel(data.usuarios)">ğŸ“Š Excel</a></li>
      <li><a class="dropdown-item" (click)="exportarCSV(data.usuarios)">ğŸ“„ CSV</a></li>
      <li><a class="dropdown-item" (click)="exportarWord(data.usuarios)">ğŸ“ Word</a></li>
      <li><a class="dropdown-item" (click)="exportarPDF(data.usuarios)">ğŸ“• PDF</a></li>
    </ul>
  </div>
</div>



  <!-- Barra de acciones -->
  <div class="acciones-bar">
  <button class="btn-nuevo" (click)="abrirModal()">
    <i class="bi bi-person-plus"></i> Nuevo
  </button>

 
  <!-- BotÃ³n de Descargas con menÃº -->



  <!-- buscadores -->
  <div class="buscadores">
    <div class="buscador">
      <i class="fas fa-user"></i>
      <input type="text" placeholder="Buscar por nombre..." [(ngModel)]="filtroNombre"/>
    </div>
    <div class="buscador">
      <i class="fas fa-id-card"></i>
      <input type="text" placeholder="Buscar por cÃ©dula..." [(ngModel)]="filtroCedula"/>
    </div>
  </div>
</div>

  <!-- Tabla de usuarios -->
  <div class="tabla-wrapper">
    <table class="tabla-usuarios">
      <thead>
        <tr>
          <th (click)="ordenar('id')">ID</th>
          <th (click)="ordenar('nombre_usuario')">Usuario</th>
          <th (click)="ordenar('nombres')">Nombres</th>
          <th (click)="ordenar('numero_documento')">CÃ©dula</th>
          <th (click)="ordenar('tipo_rol_id')">Rol</th>
          <th class="acciones-col">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of usuariosFiltrados(data.usuarios) | paginate: { itemsPerPage: pageSize, currentPage: page }">
          <td>{{ u.id }}</td>
          <td>{{ u.nombre_usuario }}</td>
          <td>{{ u.nombres }}</td>
          <td>{{ u.numero_documento }}</td>
          <td>{{ getNombreRol(u.tipo_rol_id, data.roles) }}</td>
          <td class="acciones">
            <button class="btn-accion consultar" (click)="consultarUsuario(u.id)" title="Consultar"></button>
            <button class="btn-accion editar" (click)="abrirModal(u)" title="Editar"></button>
            <button class="btn-accion eliminar" (click)="eliminarUsuario(u.id)" title="Eliminar"></button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ğŸ“Œ PaginaciÃ³n -->
  <pagination-controls (pageChange)="page = $event" class="paginacion"></pagination-controls>

  <!-- Modal de consulta -->
  <div class="modal" *ngIf="usuarioConsultado">
    <div class="modal-content">
      <h3>ğŸ‘¤ Detalles del Usuario</h3>
      <ul class="detalles-usuario">
        <li><strong>ID:</strong> {{ usuarioConsultado.id }}</li>
        <li><strong>Usuario:</strong> {{ usuarioConsultado.nombre_usuario }}</li>
        <li><strong>Nombres:</strong> {{ usuarioConsultado.nombres }}</li>
        <li><strong>Apellidos:</strong> {{ usuarioConsultado.apellidos }}</li>
        <li><strong>Documento:</strong> {{ usuarioConsultado.tipo_documento?.nombre }} - {{ usuarioConsultado.numero_documento }}</li>
        <li><strong>Celular:</strong> {{ usuarioConsultado.celular }}</li>
        <li><strong>DirecciÃ³n:</strong> {{ usuarioConsultado.direccion }}</li>
        <li><strong>Ciudad:</strong> {{ usuarioConsultado.ciudad }}</li>
        <li><strong>Email:</strong> {{ usuarioConsultado.email }}</li>
        <li><strong>Rol:</strong> {{ usuarioConsultado.tipo_rol?.nombre }}</li>
      </ul>
      <div class="modal-buttons">
        <button class="btn-cancelar" (click)="cerrarConsulta()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de crear/editar -->
  <div class="modal" *ngIf="modalVisible">
    <div class="modal-content">
      <h3>{{ editando ? 'âœï¸ Editar Usuario' : 'â• Nuevo Usuario' }}</h3>
      <div class="form-grid">
        <input placeholder="Nombre de usuario" [(ngModel)]="usuarioForm.nombre_usuario" required />
        <input placeholder="Nombres" [(ngModel)]="usuarioForm.nombres" required />
        <input placeholder="Apellidos" [(ngModel)]="usuarioForm.apellidos" required />
        <select [(ngModel)]="usuarioForm.tipo_documento_id" required>
          <option value="">Seleccione Tipo Documento</option>
          <option *ngFor="let doc of data.documentos" [value]="doc.id">{{ doc.nombre }}</option>
        </select>
        <input placeholder="NÃºmero Documento" [(ngModel)]="usuarioForm.numero_documento" required />
        <input placeholder="Celular" [(ngModel)]="usuarioForm.celular" />
        <input placeholder="DirecciÃ³n" [(ngModel)]="usuarioForm.direccion" />
        <input placeholder="Ciudad" [(ngModel)]="usuarioForm.ciudad" />
        <input type="email" placeholder="Email" [(ngModel)]="usuarioForm.email" required />
        <input type="password" placeholder="ContraseÃ±a" [(ngModel)]="usuarioForm.contrasena" [required]="!editando" />
        <select [(ngModel)]="usuarioForm.tipo_rol_id" required>
          <option value="">Seleccione Rol</option>
          <option *ngFor="let rol of data.roles" [value]="rol.id">{{ rol.nombre }}</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button class="btn-guardar" (click)="guardarUsuario()">{{ editando ? 'Actualizar' : 'Crear' }}</button>
        <button class="btn-cancelar" (click)="cerrarModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<ng-template #cargando>
  <div class="spinner-container">
    <div class="spinner"></div>
    <p>Cargando usuarios...</p>
  </div>
</ng-template>
